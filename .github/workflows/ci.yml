name: CI/CD

on:
  push:
    branches: [main]
    tags: [v*]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.10'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read
  packages: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - run: python -m pip install --upgrade pip
    - run: pip install ruff black
    - run: ruff check src/ tests/ experiments/ --ignore E402
    - run: black --check src/ tests/ experiments/ || true

  # Milestone 2: Prompt script linting and testing
  lint-prompts:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - run: python -m pip install --upgrade pip
    - run: pip install ruff black
      - name: Lint prompt experiments
        run: |
          ruff check experiments/prompts/ --ignore E501,E402
          black --check experiments/prompts/ || true

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - run: python -m pip install --upgrade pip
    - run: python -m pip install -r requirements.txt -r requirements-dev.txt
    - name: Install LLM dependencies (optional)
      run: |
        pip install -r requirements-llm.txt || echo "LLM deps not fully available"
      continue-on-error: true
    - run: echo "PYTHONPATH=src" >> $GITHUB_ENV
    - name: Run tests with coverage
      run: pytest tests/ --cov=src --cov-report=xml --cov-report=term -v --cov-fail-under=80
    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-xml
        path: coverage.xml

  # Milestone 2: Automated prompt evaluation on small dataset
  prompt-evaluation:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - run: python -m pip install --upgrade pip
    - run: python -m pip install -r requirements.txt
    - name: Install evaluation dependencies
      run: |
        pip install rouge-score sentence-transformers numpy pandas loguru
    - name: Run prompt evaluation (mock mode)
      run: |
        echo "PYTHONPATH=src:." >> $GITHUB_ENV
        python experiments/prompts/run_experiments.py --max-samples 5 --output-dir experiments/results
      continue-on-error: true
    - name: Upload evaluation results
      uses: actions/upload-artifact@v4
      with:
        name: prompt-evaluation-results
        path: experiments/results/
      if: always()

  # Milestone 2: RAG API tests
  test-rag:
    runs-on: ubuntu-latest
    needs: lint
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - run: python -m pip install --upgrade pip
    - run: python -m pip install -r requirements.txt -r requirements-dev.txt
    - name: Install RAG dependencies
      run: |
        pip install faiss-cpu sentence-transformers || echo "Some RAG deps unavailable"
      continue-on-error: true
    - run: echo "PYTHONPATH=src" >> $GITHUB_ENV
    - name: Run RAG tests
      run: pytest tests/test_rag.py tests/test_guardrails.py -v || echo "RAG tests skipped"
      continue-on-error: true

  build:
    runs-on: ubuntu-latest
    needs: [test, lint-prompts]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.CR_PAT }}
    - name: Build and push image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  # Milestone 2: Build RAG-enabled Docker image
  build-rag:
    runs-on: ubuntu-latest
    needs: [test, test-rag]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.CR_PAT }}
    - name: Build RAG image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.rag
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-rag:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-rag:latest
      continue-on-error: true

  canary:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - uses: actions/checkout@v4
    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.CR_PAT }}
    - name: Pull image
      run: docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
    - name: Start canary container
      run: |
        docker run -d --name app-canary -p 9000:8000 -e CANARY=true \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
    - name: Wait for startup
      run: sleep 10
    - name: Health check
      run: |
        curl -f http://localhost:9000/health || exit 1
        echo "Canary health check passed"
    - name: RAG health check (if available)
      run: |
        curl -f http://localhost:9000/rag/health || echo "RAG not available in canary"
      continue-on-error: true
    - if: always()
      run: docker stop app-canary && docker rm app-canary

  # Milestone 2: Canary deployment for LLM service
  canary-llm:
    runs-on: ubuntu-latest
    needs: build-rag
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.CR_PAT }}
    - name: Pull RAG image
      run: docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-rag:${{ github.sha }} || echo "RAG image not available"
      continue-on-error: true
    - name: Start LLM canary
      run: |
        docker run -d --name llm-canary -p 9001:8000 \
          -e CANARY=true \
          -e GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }} \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-rag:${{ github.sha }} || echo "Canary start failed"
      continue-on-error: true
    - name: Test LLM endpoints
      run: |
        sleep 15
        curl -f http://localhost:9001/rag/health || echo "LLM canary not available"
      continue-on-error: true
    - if: always()
      run: docker stop llm-canary 2>/dev/null && docker rm llm-canary 2>/dev/null || true

  security_scan:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - run: python -m pip install --upgrade pip
    - run: pip install -r requirements.txt pip-audit
    - name: Run pip-audit
      run: |
        pip-audit --no-deps --exit-zero || exit_code=$?
        # fail only on CRITICAL vulns
        pip-audit --no-deps --format=columns | grep -i CRITICAL && exit 1 || echo "No CRITICAL CVEs"

  # Milestone 2: Guardrail and safety tests
  safety-tests:
    runs-on: ubuntu-latest
    needs: lint
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - run: python -m pip install --upgrade pip
    - run: python -m pip install -r requirements.txt -r requirements-dev.txt
    - run: echo "PYTHONPATH=src" >> $GITHUB_ENV
    - name: Run guardrail tests
      run: pytest tests/test_guardrails.py -v || echo "Guardrail tests skipped"
      continue-on-error: true

  # Release job for tagged versions
  release:
    runs-on: ubuntu-latest
    needs: [build, canary, security_scan]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
    - uses: actions/checkout@v4
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        generate_release_notes: true
        files: |
          experiments/results/*.json
          experiments/results/*.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
